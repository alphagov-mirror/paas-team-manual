<!doctype html>
<html lang="en" class="no-js">
  <head>
    <meta content="IE=edge" http-equiv="X-UA-Compatible">
    <meta charset="utf-8">
    <meta content="width=device-width,initial-scale=1.0,minimum-scale=1.0,maximum-scale=1.0,user-scalable=no" name="viewport">
      <meta name="robots" content="noindex">

    <!-- Use title if it's in the page YAML frontmatter -->
    <title>GOV.UK Documentation</title>

    <!--[if gt IE 8]><!--><link href="../../stylesheets/screen.css" rel="stylesheet" media="screen" /><!--<![endif]-->
    <!--[if lte IE 8]><link href="../../stylesheets/screen-old-ie.css" rel="stylesheet" media="screen" /><![endif]-->

    <link rel="canonical" href="https://bandesz.github.io/paas-team-manual/architecture_decision_records/ADR012-haproxy-healthcheck/">


    <link href="../../stylesheets/print.css" rel="stylesheet" media="print" />
    <script src="../../javascripts/application.js"></script>
  </head>

  <body>
    <div class="app-pane">
      <div class="app-pane__header toc-open-disabled">
        <a href="#content" class="skip-link">Skip to main content</a>

        <header class="header header--full-width">
  <div class="header__container">
    <div class="header__brand">
        <a href="https://bandesz.github.io/paas-team-manual">
        <span class="header__title">
          PaaS Team Manual
            <span class="phase-banner">Internal</span>
        </span>
        </a>
    </div>

  </div>
</header>

      </div>

      <div id="toc-heading" class="toc-show fixedsticky">
        <a href="#toc" class="toc-show__label js-toc-show" aria-controls="toc">
          Table of contents <span class="toc-show__icon"></span>
        </a>
      </div>

      <div class="app-pane__body" data-module="in-page-navigation">
        <div class="app-pane__toc">
          <div class="toc" data-module="table-of-contents">
            <a href="#" class="toc__close js-toc-close" aria-controls="toc" aria-label="Hide table of contents"></a>
            <nav id="toc" class="js-toc-list toc__list" aria-labelledby="toc-heading">
              <ul>
  <li>
    <a href="#adr012-haproxy-healthcheck">ADR012: Haproxy healthcheck</a>
    <ul>
      <li>
        <a href="#context">Context</a>
      </li>
      <li>
        <a href="#decision">Decision</a>
      </li>
      <li>
        <a href="#status">Status</a>
      </li>
      <li>
        <a href="#consequences">Consequences</a>
      </li>
    </ul>
  </li>
</ul>

            </nav>
          </div>
        </div>

        <div class="app-pane__content toc-open-disabled">
          <main id="content" class="technical-documentation" data-module="anchored-headings">
            <h1 id="adr012-haproxy-healthcheck">ADR012: Haproxy healthcheck</h1><h2 id="context">Context</h2>
<p>Stories: <a href="https://www.pivotaltracker.com/story/show/123490171">#123490171</a> &amp; <a href="https://www.pivotaltracker.com/story/show/121933113">#121933113</a></p>

<p>We were investigating how to avoid downtime to deployed applications when we
made changes to the platform. We had discovered that short outages occurred
when the gorouter was taken out of service.</p>

<p>gorouter has drain functionality to allow upstream load balancers to gracefully
take instances of the gorouter out of service before any requests start to
fail.</p>

<p>When a USR1 signal is sent to instruct the gorouter to start draining,
healthchecking requests, identified by the header <code>User-Agent: HTTP-Monitor/1.1</code>
start failing with HTTP 503. User requests are allowed to continue.</p>

<p>Two things prevented us from using drain mode:</p>

<ul>
<li>we had the ELB configured to use TCP healthchecks, not HTTP</li>
<li>the ELB sends HTTP healthcheck requests with <code>User-Agent:
ELB-HealthChecker/1.0</code>, which means they were not recognised as healthcheck
requests by gorouter, they returned HTTP 200 and the ELB did not take the
draining gorouter out of service.</li>
</ul>

<p>The result was a very small amount of downtime for deployed apps that received
requests during a short window of &lt; 1 second.</p>
<h2 id="decision">Decision</h2>
<p>We decided to:</p>

<ul>
<li>submit a change upstream to <a href="https://github.com/cloudfoundry/gorouter/pull/138">allow the gorouter to recognise ELB
healthchecks</a></li>
<li>implement a healhchecking port 82, in the HAProxy we introduced in ADR008,
which appends the <code>User-Agent: HTTP-Monitor/1.1</code> that gorouter expects</li>
<li>enable HTTP healthchecks on the ELB</li>
</ul>
<h2 id="status">Status</h2>
<p>Accepted</p>
<h2 id="consequences">Consequences</h2>
<ul>
<li>There was less downtime for deployed applications during a deploy.</li>
<li>We have an additional reason to keep the intermediate HAProxy we introduced as a temporary measure.</li>
</ul>

          </main>

          <footer class="footer">
  <div class="footer__licence">
    <a class="footer__licence-logo" href="https://www.nationalarchives.gov.uk/doc/open-government-licence/version/3/" rel="license">Open Government Licence</a>
    <p class="footer__licence-description">All content is available under the <a href="https://www.nationalarchives.gov.uk/doc/open-government-licence/version/3/" rel="license">Open Government Licence v3.0</a>, except where otherwise stated</p>
  </div>

  <div class="footer__copyright">
    <a class="footer__copyright-logo" href="http://www.nationalarchives.gov.uk/information-management/re-using-public-sector-information/copyright-and-re-use/crown-copyright/">Â© Crown copyright</a>
  </div>
</footer>

        </div>
      </div>
    </div>

    
  </body>
</html>
