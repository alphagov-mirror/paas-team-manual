<!doctype html>
<html lang="en" class="no-js">
  <head>
    <meta content="IE=edge" http-equiv="X-UA-Compatible">
    <meta charset="utf-8">
    <meta content="width=device-width,initial-scale=1.0,minimum-scale=1.0,maximum-scale=1.0,user-scalable=no" name="viewport">
      <meta name="robots" content="noindex">

    <!-- Use title if it's in the page YAML frontmatter -->
    <title>GOV.UK Documentation</title>

    <!--[if gt IE 8]><!--><link href="/stylesheets/screen.css" rel="stylesheet" media="screen" /><!--<![endif]-->
    <!--[if lte IE 8]><link href="/stylesheets/screen-old-ie.css" rel="stylesheet" media="screen" /><![endif]-->

    <link rel="canonical" href="team-manual.cloud.service.gov.uk/team/rotating_credentials/">


    <link href="/stylesheets/print.css" rel="stylesheet" media="print" />
    <script src="/javascripts/application.js"></script>
  </head>

  <body>
    <div class="app-pane">
      <div class="app-pane__header toc-open-disabled">
        <a href="#content" class="skip-link">Skip to main content</a>

        <header class="header header--full-width">
  <div class="header__container">
    <div class="header__brand">
        <a href="https://cloud.service.gov.uk">
        <span class="header__title">
          PaaS Team Manual
            <span class="phase-banner">Internal</span>
        </span>
        </a>
    </div>

  </div>
</header>

      </div>

      <div id="toc-heading" class="toc-show fixedsticky">
        <a href="#toc" class="toc-show__label js-toc-show" aria-controls="toc">
          Table of contents <span class="toc-show__icon"></span>
        </a>
      </div>

      <div class="app-pane__body" data-module="in-page-navigation">
        <div class="app-pane__toc">
          <div class="toc" data-module="table-of-contents">
            <a href="#" class="toc__close js-toc-close" aria-controls="toc" aria-label="Hide table of contents"></a>
            <nav id="toc" class="js-toc-list toc__list" aria-labelledby="toc-heading">
              <ul>
  <li>
    <a href="#rotating-credentials">Rotating Credentials</a>
    <ul>
      <li>
        <a href="#third-party-services">Third-party services</a>
      </li>
      <li>
        <a href="#platform">Platform</a>
        <ul>
          <li>
            <a href="#rotating-passwords">Rotating passwords</a>
          </li>
          <li>
            <a href="#rotating-certificates">Rotating certificates</a>
          </li>
          <li>
            <a href="#aws-keys-generated-in-the-pipeline">AWS keys generated in the pipeline</a>
          </li>
          <li>
            <a href="#limited-functionality-during-rotation">Limited functionality during rotation</a>
          </li>
        </ul>
      </li>
    </ul>
  </li>
</ul>

            </nav>
          </div>
        </div>

        <div class="app-pane__content toc-open-disabled">
          <main id="content" class="technical-documentation" data-module="anchored-headings">
            <h1 id="rotating-credentials">Rotating Credentials</h1><h2 id="third-party-services">Third-party services</h2>
<p>We store credentials for third-party services in <a href="https://www.passwordstore.org/"><code>pass</code></a> stores which have some documentation about rotating the secrets held in them:</p>

<ul>
<li>https://github.com/alphagov/paas-credentials/blob/master/SECRET_ROTATION.md</li>
<li>https://github.com/alphagov/paas-credentials-high/blob/master/SECRET_ROTATION.md</li>
</ul>
<h2 id="platform">Platform</h2>
<p>From time to time, it might be necessary to rotate our platform credentials. We have created helper tasks in the deployer and bootstrap pipelines, credentials tab, to clean passwords that we know are safe to re-set.</p>
<h3 id="rotating-passwords">Rotating passwords</h3>
<p>Rotating passwords consists of two phases. First, you delete credentials using one of the helper tasks. There&rsquo;s one for CF (in the deployer pipeline), one for BOSH and one for Concourse (in the bootstrap pipeline). These tasks exclude passwords that are difficult or not safe to rotate and clean all other passwords. We do also delete generated ssh keys in these tasks.</p>

<p>Second phase consists of running the main pipeline (on deployer for CF, on bootstrap for BOSH and Concourse) to generate new credentials and apply them. Ensure that there is nothing else triggering this 2nd phase run, as that would mean you would be rotating passwords <em>and</em> trying to apply some changes at the same time, which might not work and you could end up with broken deployment. Pipeline run should complete successfully and all tests should pass. There should be no interruptions to deployed apps.</p>
<h3 id="rotating-certificates">Rotating certificates</h3>
<p>Rotating the certificates that Cloud Foundry using internally for mutual TLS
between components is a much longer process. You need to:</p>

<ol>
<li>Run <code>rotate-cf-certs-cas</code> to copy existing CAs into <code>_old</code> suffixes</li>
<li>Run <code>create-cloudfoundry</code> to generate new CAs and deploy them alongside the old CAs</li>
<li>Run <code>rotate-cf-certs-leafs</code> to delete existing non-CA certs</li>
<li>Run <code>create-cloudfoundry</code> to generate new non-CA certs against the new CAs and deploy them</li>
<li>Run <code>delete-old-cf-certs</code> to delete old CAs</li>
<li>Run <code>create-cloudfoundry</code> to remove the old CAs</li>
</ol>
<h3 id="aws-keys-generated-in-the-pipeline">AWS keys generated in the pipeline</h3>
<p>The deployer Concourse has a job for triggering the rotation of AWS keys generated in the pipeline. These keys currently include:</p>

<ul>
<li>Those used for generating SES SMTP credentials used by UAA for sending account management emails.</li>
<li>Those used by the metrics tool to check the validity of CloudFront certificates.</li>
</ul>

<p>The job works by removing the resources from the Terraform state file (without touching the keys themselves). This causes new access keys to be generated on the next pipeline run. Unused keys are deleted in a post-deploy job after every pipeline run. This operation is safe to do at any time, so it triggers automatically every 30 days. It is also included as a step in the manual credential rotation job.</p>
<h3 id="limited-functionality-during-rotation">Limited functionality during rotation</h3>
<p>We have lot of functionality that requires credentials outside of the pipeline. These are mainly our scripts that are orchestrated via Makefile. Most of the tasks (like <code>bosh-cli</code> or any ssh tasks) will not work during rotation, as they need credentials (concourse password, ssh keys) that have been deleted and are either not available or not applied yet.</p>

<p>In case you need to run any of these tasks in the middle of the rotation, but before the new credentials have been applied, we suggest that you pause the pipeline first. You can download previous versions of the keys and secret files to recover needed credentials and either use them locally, or re-upload these files as latest version to the bucket. Note that if your pipeline will get into credential applying stage after you unpause, it will apply the latest uploaded credentials. If these are previous version, this means no actual credential rotation will happen and pipeline should finish without needing to apply any changes. If you still want to rotate credentials afterwards, repeat the rotation procedure again.</p>

          </main>

          <footer class="footer">
  <div class="footer__licence">
    <a class="footer__licence-logo" href="https://www.nationalarchives.gov.uk/doc/open-government-licence/version/3/" rel="license">Open Government Licence</a>
    <p class="footer__licence-description">All content is available under the <a href="https://www.nationalarchives.gov.uk/doc/open-government-licence/version/3/" rel="license">Open Government Licence v3.0</a>, except where otherwise stated</p>
  </div>

  <div class="footer__copyright">
    <a class="footer__copyright-logo" href="http://www.nationalarchives.gov.uk/information-management/re-using-public-sector-information/copyright-and-re-use/crown-copyright/">Â© Crown copyright</a>
  </div>
</footer>

        </div>
      </div>
    </div>

    
  </body>
</html>
